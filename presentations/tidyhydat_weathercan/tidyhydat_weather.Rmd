---
title: "Introduction to working with Canadian Water Data in R"
subtitle: "Using tidyhydat and weathercan"
author: "Sam Albers <br> Digital Platforms and Data Division <br> Office of the Chief Information Officer <br> Ministry of Citizens' Services <br> Province of BC <br><br> CWRA Webinar <br>"
date: 2019-09-25
output:
  xaringan::moon_reader:
    keep_md: true
    lib_dir: libs
    css: ["default", "default-fonts", "hygge"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "https://platform.twitter.com/widgets.js"
      ratio: '16:9'
---

layout: true

---

```{r, include=FALSE}
# Copyright 2019 Province of British Columbia
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and limitations under the License.
```


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(width = 90)
options(max_print = 5)

knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  comment = "#>",
  fig.path = "graphics/prod/figs"
)

options(scipen = 10)
```

```{r, pck-load, warning=FALSE, message=FALSE}
library(tidyhydat)
library(weathercan)
library(knitr)
library(tidyverse)
library(lubridate)
library(corrr)
library(sf)
library(rnaturalearth)
```


```{r, theme, warning=FALSE, echo=FALSE}
bg_black <- "#272822"

theme_set(theme_void() %+replace%
            theme(legend.text = element_text(colour = "white", size = 18),
                  legend.title = element_text(colour = "white", size = 18),
                  plot.background = element_rect(fill = bg_black, color = bg_black),
                  axis.text = element_text(colour = "white", size = 16),
                  axis.title = element_text(colour = "white", size = 18),
                  axis.title.y = element_text(angle = 90, vjust = 1),
                  plot.title = element_text(colour = "white", size = 22, hjust = 0)))


scale_colour_continuous <- scale_colour_viridis_c
scale_fill_continuous <- scale_fill_viridis_c
scale_colour_discrete <- scale_colour_viridis_d
scale_fill_discrete <- scale_fill_viridis_d
```



## Outline

.VeryLarge[
- Introduction to me
- Common Analysis Problems
- What is R?
- Why use R?
- RStudio
 - Cover RStudio configuration
 - Provide link to Best Practices with Spreadsheets
- Introduction to the tidyverse
- Provide an interactive, introductory tutorial to access ECCC data from R
 - Introduce tidyhydat
  - Gush about HYDAT
  - Replicated `nrow`, `str` etc
  - Don't forget to introduce the print methods and the plot
  - Make a call out for wo
 - Introduce weathercan
 - Provide an example of using them together (How do I use them together?)
 - Ideas
  - Catalogue is big storm in Canada
- Where to get help
- Questions

- A review of how to ask for help in the R language
  - reprex
- Show off time
- Add in Hydrology task view
]

---
## What are we hoping to learn?
.VeryLarge[
- Describe visual elements of RStudio
- Define and assign data to variable
- Manage your workspaces
- Call a function
- Understand the six main dplyr verbs
- Overview of tidyhydat and weathercan functions
- Describe usage of both functions
- Provide an example
]

---
Possibly one does not learn R in one afternoon slide

---
class: inverse, center, middle
# Common Analysis Problems
---
class: center, basic
## Accessing Enviroment and Climate Canada Data
```{r data-explorer, out.width = "85%"}
include_graphics("graphics/ec_data_explorer2.gif")
```

### 11 clicks!

---

class: basic, center

### Stakeholder/Manager: "Hey, this is a really cool analysis but we need to add five stations. Can you run it again?"
<img src="https://media.giphy.com/media/l4FGuE8LtZg2wKmZi/giphy.gif"/>

--
### Make it reproducible!

---
class: inverse, left, middle
## ...Use R!
.pull-left[
(or more generally any programmatic code based analysis approach...)
]
<center><img src="https://www.r-project.org/logo/Rlogo.png" alt="Drawing" style="width: 450px;" /></center>
---
.pull-left[
### What is R?
.large[
- Free and open source
- Statistical programming language
- Publication quality graphics
- But definitely not intimidating...
]
]

--
.pull-right[
### Why use R?

.large[
- Efficient
- Reproducible
- Scalable
]
]

--
### Not guaranteed to help with this...
<center><img src="https://media.giphy.com/media/HteV6g0QTNxp6/giphy.gif" style="width: 450px;"/> </center>

---

## Questions worth asking...
.large[
- Are your methods <span style="color:#309688">reproducible</span>?
- What is your analysis recipe? 
- Can you share it?
]

<center><img src="graphics/data_recipe.png" alt="Drawing" style="width: 750px;" /></center>
---

## Excuse me,  do you have a  moment to talk about Excel?

<img src="http://ichef.bbci.co.uk/news/976/cpsprodpb/CED0/production/_89744925_clippy.jpg"/>

---
class:basic

| R                                         | Excel                                                  |
|-------------------------------------------|--------------------------------------------------------|
| Data and analysis are separate            | Data and analysis are usually stored in the same place |

<br>

<center><img src="https://i0.wp.com/civilengineerspk.com/wp-content/uploads/2016/04/excel2010_06.jpg" alt="Drawing" style="width: 450px;" /></center>

.footnote[
From: http://blog.yhat.com/posts/R-for-excel-users.html.
]

---
class:basic

| R                                         | Excel                                                  |
|-------------------------------------------|--------------------------------------------------------|
| Data and analysis are separate            | Data and analysis are usually stored in the same place |
| Data structure is strict                  | Data structure is flexible                             |

<br>

<center><img src="https://i.stack.imgur.com/d9cMS.jpg" alt="Drawing" style="width: 450px;" /></center>


.footnote[
From: http://blog.yhat.com/posts/R-for-excel-users.html.
]

---
class:basic

| R                                         | Excel                                                  |
|-------------------------------------------|--------------------------------------------------------|
| Data and analysis are separate            | Data and analysis are usually stored in the same place |
| Data structure is strict                  | Data structure is flexible                             |
| Operations are achieved through scripting | Operations are achieved through pointing and clicking  |

<br>

<center><img src="https://media.giphy.com/media/UMbqRmfi03SQE/giphy.gif" alt="Drawing" style="width: 400px;" /></center>



.footnote[
From: http://blog.yhat.com/posts/R-for-excel-users.html.
]

---
class:basic

| R                                         | Excel                                                  |
|-------------------------------------------|--------------------------------------------------------|
| Data and analysis are separate            | Data and analysis are usually stored in the same place |
| Data structure is strict                  | Data structure is flexible                             |
| Operations are achieved through scripting | Operations are achieved through pointing and clicking  |
| Iteration is automated                    | Iteration is usually done by hand                      |

### R provides a clear pathway for <span style="color:#309688">efficiency</span> and <span style="color:#309688">reproducibility</span> through automation and code

### üìù But we all have to work in excel so read this: [Data Organization in Spreadsheets](https://www.tandfonline.com/doi/full/10.1080/00031305.2017.1375989)

.footnote[
From: http://blog.yhat.com/posts/R-for-excel-users.html.
]


---


## <span style="color:#309688">tidy</span>::tidy data
> Tidy datasets are all alike but every messy dataset is messy in its own way<sup>1</sup>

--

### Each variable forms a column

### Each observation forms a row

<center><img src="https://media.giphy.com/media/kXBVtKjLxINji/giphy.gif" style="width: 450px;"/> </center>

.footnote[
[1] [Wickham, Hadley. 2014. Tidy Data. Journal of Statistical Software 59 (10). Foundation for Open Access Statistics: 1‚Äì23.](https://www.jstatsoft.org/article/view/v059i10)
]

---

.pull-left[
## The Problem
- Many tasks when analyzing environmental data are repetitive yet interactive
- Helpful to abstract away unneeded complexity when possible
- A clean and easy to remember syntax reduces your cognitive load when doing analysis



<center><img src="https://www.herocollector.com/Content/ArticleImages/7a716739-72cb-40d5-acfc-dfc35783d8a5.jpg" style="width: 450px;"/></center>



]

--

.pull-right[
## Enter `dplyr`
> a consistent set of verbs that help you solve the most common data manipulation challenges

- Independent of the data source
- Designed for data science

<center><img src="https://raw.githubusercontent.com/rstudio/hex-stickers/master/PNG/dplyr.png" style="width: 300px;"/></center>

]

---

## Some slide introducing packages

---

##`dplyr` verbs

Functions with English meanings that map directly to the action being taken when that function is called

.pull-left[
- `%>%` a special symbol to chain operations. Read it as "then"
- `select()` picks variables based on their names.
- `filter()` picks cases based on their values.
- `summarise()` reduces multiple values down to a single summary.
- `arrange()` changes the ordering of the rows.
- `mutate()` adds new variables that are functions of existing variables

For a offline tutorial: http://swcarpentry.github.io/r-novice-gapminder/13-dplyr/index.html
]


.pull-right[
<center><img src="https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/rstats-artwork/dplyr_wrangling.png" style="width: 450px;"/></center>

Artwork by [@allison_horst](https://twitter.com/allison_horst)
] 


---
class:basic

> The objective of tidyhydat is to provide a standard method of accessing ECCC hydrometric data sources (historical and real time) using a consistent and easy to use interface that employs tidy data principles within the R project.

<center><img src="https://github.com/ropensci/tidyhydat/raw/master/man/figures/tidyhydat_large.png" alt="Drawing" style="width: 300px;" /></center>

---

## hydat::Water Survey of Canada Network

.pull-left[
```{r eval=TRUE, message=FALSE, cache=TRUE, fig.width=6.9, fig.height=5.9, fig.align='center'}
stns <- hy_stations() %>% 
  filter(HYD_STATUS == "ACTIVE")

stns_sf <- st_as_sf(stns, coords = c("LONGITUDE","LATITUDE"),
             crs = 4326,
             agr= "constant") 

can <- ne_countries(country = "Canada", returnclass = "sf")

ggplot() +
  geom_sf(data = can, fill = NA) +
  geom_sf(data = stns_sf, size = 1, aes(colour = PROV_TERR_STATE_LOC)) +
  guides(colour = FALSE) +
  coord_sf(crs = 102009, datum = NA) +
  theme_void()
```
]

.pull-right[

## `r round(fs::file_size(file.path(hy_dir(), "Hydat.sqlite3"))/1E9,2)` GB
## `r nrow(hy_stations())` stations in database
## SQLite database
## Self contained
]

---
class:basic

> The objective of weathercan is to provide a standard method of accessing ECCC climate data sources using a consistent and easy to use interface that employs tidy data principles within the R project.

<center><img src="https://raw.githubusercontent.com/ropensci/weathercan/master/inst/assets/weathercan_logo.png" alt="Drawing" style="width: 300px;" /></center>


---

## weathercan::Climate Data

.pull-left[
```{r eval=TRUE, message=FALSE, cache=TRUE, fig.width=6.9, fig.height=5.9, fig.align='center'}
stations_unique <- stations %>% 
  select(prov, station_name, lat, lon) %>% 
  unique()



weather_stns_sf <- stations_unique %>%
  filter(!station_name == "POINT LEPREAU") %>% 
  filter(!is.na(lat), !is.na(lon)) %>% 
  st_as_sf(coords = c("lon","lat"),
             crs = 4326,
             agr= "constant") 

can <- ne_countries(country = "Canada", returnclass = "sf")

ggplot() +
  geom_sf(data = can, fill = NA) +
  geom_sf(data = weather_stns_sf, size = 1, aes(colour = prov)) +
  guides(colour = FALSE) +
  coord_sf(crs = 102009, datum = NA) +
  theme_void()
```
]

.pull-right[


## `r length(unique(stations$station_name))` stations 
## Available online
]
---

class: inverse, center, middle
# Looking closer at tidyhydat and weathercan

---

class: basiclh

## tidyhydat & some basic R
```{r download, echo = TRUE, eval = FALSE, message=FALSE}
download_hydat()
```


```{r flow_ex, echo = TRUE, eval = TRUE, message=FALSE}
flows_data <- hy_daily_flows(station_number = c("08MF005","09CD001","05KJ001","02KF005"))
```

- `<-`: <span style="color:#309688">assignment operator</span>
- `flows_data`: <span style="color:#309688">object</span>
- `hy_daily_flows`: <span style="color:#309688">function</span>
- `station_number`: <span style="color:#309688">argument</span>
---

```{r, echo = TRUE, eval = TRUE, message=FALSE}
flows_data
```

---

## What else is available in `tidyhydat`?

### All tables in HYDAT 
.Large[
- Instantaneous peaks
- Daily, monthly and yearly temporal summaries
- Discharge, level, sediment, particle size
- Data ranges
- Station metadata
]

---

## What else is available in `tidyhydat`?
```{r, echo = TRUE, eval = TRUE}
search_stn_name("fraser")
```

---
## What else is available in `tidyhydat`?
```{r, message=FALSE, warning=FALSE, fig.width=11, fig.height=5, echo = TRUE, eval = TRUE}
plot(flows_data)
```


---
## What else is available in R?
```{r, warning=FALSE, message=FALSE, echo=TRUE}
raw_stns <- hy_stations() %>%
  select(STATION_NUMBER:PROV_TERR_STATE_LOC, DRAINAGE_AREA_GROSS)
  
mad_long_avg <- hy_annual_stats(raw_stns$STATION_NUMBER) %>%
  filter(Sum_stat == "MEAN", Parameter == "Flow") %>%
  group_by(STATION_NUMBER) %>%
  summarise(Value = mean(Value, na.rm = TRUE)) %>%
  right_join(raw_stns)
mad_long_avg #<<
```

---
## What else is available in R?

```{r, warning=FALSE, message=FALSE, echo=TRUE, fig.height=5, fig.width=11}
library(ggplot2)
ggplot(mad_long_avg,aes(x = Value, y = DRAINAGE_AREA_GROSS, colour = PROV_TERR_STATE_LOC)) +
  geom_point() +
  scale_y_continuous(trans = "log10") +
  scale_x_continuous(trans = "log10") +
  scale_colour_viridis_d(name = "Jurisdiction") +
  labs(x = "Mean long term annual discharge (m^3)", y = "Gross drainage area (km^2)") +
  theme_minimal()
```

---
## An example of combining Dorian
```{r}
## Download the data
zip_path <- tempfile()
download.file("https://www.nhc.noaa.gov/gis/best_track/al052019_best_track.zip",
              destfile = zip_path)
unzip(zip_path, exdir = "presentations/tidyhydat_weathercan/data/dorian")

## Read in
dorian <- read_sf("presentations/tidyhydat_weathercan/data/dorian/AL052019_pts.shp")
north_america = ne_countries(continent = "North America", returnclass = "sf")

ggplot() +
  geom_sf(data = north_america) +
  geom_sf(data = dorian, colour = "red") +
  theme_void()
```

---
## Only Canada part
```{r}
ne_countries()
```




---

## It can be daunting!

<center><img src="https://media.giphy.com/media/iKhphMBOk5ScE/giphy.gif" style="width: 650px;"/></center>

---

## Resources for R

<img src="https://cdn.sstatic.net/Sites/stackoverflow/company/img/logos/so/so-logo.svg?v=2bb144720a66" alt="Drawing" style="width: 400px;" />


<img src="https://www.rstudio.com/wp-content/uploads/2017/11/logoRStudioCommunity.svg" alt="Drawing" style="width: 400px;" />

<center><img src="https://www.r-project.org/logo/Rlogo.png" alt="Drawing" style="width: 300px;" /></center>





---
## Contribute to `tidyhydat`

### Openly developed on GitHub <img src = "https://assets-cdn.github.com/images/modules/logos_page/GitHub-Mark.png" style = "width: 35px; vertical-align: middle; margin-bottom: 3px;">
<https://github.com/ropensci/tidyhydat>

Any contribution helps. You don't have to be an R programmer!

.pull-left[
- Questions
- Ideas / Feature-requests
- Bugs
- Bug-fixes
- Development
]
.pull-right[
<center><img src="https://github.com/ropensci/tidyhydat/raw/master/man/figures/tidyhydat_large.png" alt="Drawing" style="width: 150px;" /></center>
]
--

### For example...
```{r, eval=FALSE, echo = TRUE}
Authors@R: c(person("Sam", "Albers",email = "sam.albers@gov.bc.ca", role = c("aut", "cre")),
    person("David", "Hutchinson", email = "david.hutchinson@canada.ca", role = "ctb"), #<<
    person("Dewey", "Dunnington", email = "dewey@fishandwhistle.net", role = "ctb"), #<<
    person("Province of British Columbia", role = "cph"))
```
---
## Way to contribute:
- SQL code embedded to efficiently do analysis - leverage the database
- Documentation - write a vignette!

## Ways to cite
```{r}
citation("tidyhydat")
```

```{r}
citation("weathercan")
```


---

class: inverse, center
## Some Helpful Links

Installing R & RStudio with local package libraries

    -https://github.com/bcgov/bcgov-data-science-resources/wiki/Installing-R-&-RStudio

Installing tidyhydat

    -https://cran.rstudio.com/web/packages/tidyhydat/README.html

Getting started with `tidyhydat`

    -https://cran.rstudio.com/web/packages/tidyhydat/vignettes/tidyhydat_an_introduction.html
    -https://cran.rstudio.com/web/packages/tidyhydat/vignettes/tidyhydat_example_analysis.html

BC Gov data science resource wiki

    -https://github.com/bcgov/bcgov-data-science-resources/wiki
    
---

class: basic
background-image: url(https://media.giphy.com/media/TnDoEoXfT7YoE/giphy.gif)
background-size: cover

## Questions?
.content-box-blue[
Slides available from 

    -https://github.com/ropensci/tidyhydat/blob/master/presentations/tidyhydat_intro.pdf
    -https://github.com/ropensci/tidyhydat/blob/master/presentations/tidyhydat_intro.Rmd
 
Contact <sam.albers@gov.bc.ca>
]


